pipeline {

agent none

environment {
  MAJOR_VERSION=1
}

stages  {
  stage('Say Hello'){
    agent any
    steps{
    sayHello 'Aashrith'  
    }

  }
 stage('build'){
   agent{
     label 'apache'
   }
   steps{
    sh  'ant -f build.xml -v'
   }
   post {
     success {
         archiveArtifacts artifacts: 'dist/*.jar', fingerprint: true
     }
   }
 }
 stage('deploy'){
   agent{
     label 'apache'
   }
   steps{
       sh "cp dist/rectangle_${env.MAJOR_VERSION}.${env.BUILD_NUMBER}.jar /var/www/html/rectangle/all/${env.BRANCH_NAME}/"
   }
 }
 stage('running on CentOS'){
   agent{
     label 'CentOS'
   }
   steps{
     sh "wget http://skakella3.mylabserver.com/rectangle/all/${env.BRANCH_NAME}/rectangle_${env.MAJOR_VERSION}.${env.BUILD_NUMBER}.jar"
     sh "java -jar rectangle_${env.MAJOR_VERSION}.${env.BUILD_NUMBER}.jar 3 4"
   }
 }
 stage('Running on Debian OS') {
   agent{
     docker 'openjdk:8u131-jre'
   }
   steps{
     sh "wget http://skakella3.mylabserver.com/rectangle/all/${env.BRANCH_NAME}/rectangle_${env.MAJOR_VERSION}.${env.BUILD_NUMBER}.jar"
     sh "java -jar rectangle_${env.MAJOR_VERSION}.${env.BUILD_NUMBER}.jar 3 4"
   }
 }
 stage('Promote To Green'){
   agent{
     label 'apache'
   }
   when{
     branch 'master'
   }
   steps{
     sh "cp /var/www/html/rectangle/all/${env.BRANCH_NAME}/rectangle_${env.MAJOR_VERSION}.${env.BUILD_NUMBER}.jar /var/www/html/rectangle/green/rectangle_${env.MAJOR_VERSION}.${env.BUILD_NUMBER}.jar"
   }
   }
   stage('Promote Dev Branch To Master'){
     agent{
       label 'apache'
     }
     when{
       branch 'development'
     }
     steps{
      echo "Stashing Development changes"
      sh "git stash"
      echo "Checkout Development changes"
      sh "git checkout development"
      echo "Checkout master changes"
      sh "git checkout master"
      echo "Merge Development changes to Master branch"
      sh "git merge development"
      echo "Push master branch changes to github"
      sh "git push origin master"
      echo "Tag the project"
      sh "git tag rectangle-${env.MAJOR_VERSION}.${env.BUILD_NUMBER}"
      sh "git push origin rectangle-${env.MAJOR_VERSION}.${env.BUILD_NUMBER}"

       }
       post{
         success{
           emailext(
             subject: "${env.JOB_NAME} [${env.build}] Development promoted to Master",
             body: """<p>'${env.JOB_NAME} [${env.build}] Development promoted to Master!'</p>
                     <p>Check console output at &QUOT;<a  href='${env.BUILD_URL}'>${env.JOB_NAME} [${env.build}]</a>&QUOT;</p>""",
             to: "akella1980@gmail.com"

             )
         }
       }

     }

}

post{
  failure{
    emailext(
      subject: "${env.JOB_NAME} [${env.build}] failed!",
      body: """<p>'${env.JOB_NAME} [${env.build}] failed!'</p>
              <p>Check console output at &QUOT;<a  href='${env.BUILD_URL}'>${env.JOB_NAME} [${env.build}]</a>&QUOT;</p>""",
      to: "akella1980@gmail.com"

      )
  }
}

}
